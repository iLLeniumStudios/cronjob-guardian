name: Tests

on:
  push:
  pull_request:

jobs:
  test-go:
    name: Go Tests
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build UI (required for go:embed)
        run: make ui-build

      - name: Running Tests
        run: |
          go mod tidy
          make test

  build-ui:
    name: UI Build
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: ui

      - name: Build UI
        run: bun run build
        working-directory: ui

      - name: Verify build output
        run: |
          if [ ! -d "ui/out" ]; then
            echo "Build output directory not found"
            exit 1
          fi
          echo "Build output size:"
          du -sh ui/out

  build-full:
    name: Full Build (Go + UI)
    runs-on: ubuntu-latest
    needs: [test-go, build-ui]
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build full application
        run: make build

      - name: Verify binary
        run: |
          if [ ! -f "bin/manager" ]; then
            echo "Manager binary not found"
            exit 1
          fi
          echo "Binary size:"
          ls -lh bin/manager
