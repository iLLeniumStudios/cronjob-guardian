name: CI

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - 'v*'
      - 'chart-v*'
  pull_request:

env:
  KIND_VERSION: v0.31.0

jobs:
  # =============================================================================
  # UI Chain: build-ui => lint-ui
  # =============================================================================
  build-ui:
    name: Build UI
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ui/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('ui/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: ui

      - name: Build UI
        run: bun run build
        working-directory: ui

      - name: Upload UI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-build
          path: ui/out
          retention-days: 1

  lint-ui:
    name: Lint UI
    needs: build-ui
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ui/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('ui/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: ui

      - name: Run ESLint
        run: bun run lint
        working-directory: ui

      - name: Run TypeScript type check
        run: bun run typecheck
        working-directory: ui

  # =============================================================================
  # Go Chain: build-go => lint-go => test-go
  # =============================================================================
  build-go:
    name: Build Go
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Cache Go tools
        uses: actions/cache@v4
        with:
          path: bin
          key: go-tools-${{ runner.os }}-${{ hashFiles('Makefile') }}
          restore-keys: go-tools-${{ runner.os }}-

      - name: Build
        run: go build ./...

  lint-go:
    name: Lint Go
    needs: build-go
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run linter
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.7.2

  test-go:
    name: Test Go
    needs: lint-go
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Cache Go tools
        uses: actions/cache@v4
        with:
          path: bin
          key: go-tools-${{ runner.os }}-${{ hashFiles('Makefile') }}
          restore-keys: go-tools-${{ runner.os }}-

      - name: Run tests
        run: make test

  # =============================================================================
  # Full Build - depends on both chains completing
  # =============================================================================
  build-full:
    name: Full Build
    needs: [lint-ui, test-go]
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download UI artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-build
          path: ui/out

      - name: Build Go binary
        run: go build -o bin/manager ./cmd/

      - name: Verify binary
        run: |
          if [ ! -f "bin/manager" ]; then
            echo "Manager binary not found"
            exit 1
          fi
          echo "Binary size:"
          ls -lh bin/manager

  # =============================================================================
  # E2E Tests - runs after full build passes
  # =============================================================================
  test-e2e:
    name: E2E Tests
    needs: build-full
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Cache Go tools
        uses: actions/cache@v4
        with:
          path: bin
          key: go-tools-${{ runner.os }}-${{ hashFiles('Makefile') }}
          restore-keys: go-tools-${{ runner.os }}-

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ui/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('ui/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache kind binary
        uses: actions/cache@v4
        id: kind-cache
        with:
          path: /usr/local/bin/kind
          key: kind-${{ runner.os }}-${{ env.KIND_VERSION }}

      - name: Install kind
        if: steps.kind-cache.outputs.cache-hit != 'true'
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Run E2E tests
        env:
          CERT_MANAGER_INSTALL_SKIP: "true"
        run: make test-e2e
